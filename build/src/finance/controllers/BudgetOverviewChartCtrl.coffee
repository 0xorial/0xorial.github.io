app.controller 'BudgetOverviewChartCtrl', ($scope, SimulationService) ->

  # $.getJSON 'https://www.highcharts.com/samples/data/jsonp.php?filename=aapl-c.json&callback=?', (data) ->
  #   # Create the chart
  #   $('#container').highcharts 'StockChart',
  #     # rangeSelector: selected: 1
  #     series: [ {
  #       name: 'AAPL'
  #       data: data
  #       tooltip: valueDecimals: 2
  #     } ]
  # return

# ---
# generated by js2coffee 2.1.0

  update = ->
    context = SimulationService.getLastSimulation()
    if !context
      context = SimulationService.runSimulation()

    $scope.allTransactions = context.transactions
    transactionsByAccount = _.groupBy(context.transactions, (t) -> t.account.name)

    labels = []
    series = []

    allTransactionsByDate = _.groupBy(transactions, (t) -> t.date.valueOf())
    for d of allTransactionsByDate
      labels.push(d)

    for a of transactionsByAccount
      data = []
      transactions = transactionsByAccount[a]
      account = transactions[0].account
      transactionsByDate = _.groupBy(transactions, (t) -> t.date.valueOf())
      for d of transactionsByDate
        dateTransactions = transactionsByDate[d]
        t = dateTransactions[0]
        balance = t.accountState.getAccountBalance(t.account)
        data.push({
          # name: t.description,
          # fill: t.account.color,
          x: t.date.valueOf(),
          y: balance})

      series.push({
        color: tinycolor(account.color).toHexString(),
        # name: a.name,
        data: data
        marker:
            enabled: true
            radius: 4
      })

    # series = [
    #   marker:
    #     enabled: true
    #     radius: 4
    #   data: [
    #     {
    #       x: new Date()
    #       y: 100
    #     }
    #     {
    #       x: new Date('2011-04-11')
    #       y: 100
    #     }
    #   ]
    # ]

    $scope.chartConfig = {
      useHighStocks: true
      options:
        chart:
          type: 'line'
          xAxis:
            type: 'datetime'
        rangeSelctor:
          selected:4
          enabled: true
          height: 200
        navigator:
          enabled: true
      series: series,
      size: {
       width: 600,
       height: 500
      }
    }

    # $('#container').highcharts {
    #   chart:
    #     type: 'StockChart',
    #   series: series
    # }
  update()

  $scope.$on 'simulationRan', (__, c) ->
    update()
