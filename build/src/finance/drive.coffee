# Your Client ID can be retrieved from your project in the Google
# Developer Console, https://console.developers.google.com
CLIENT_ID = '738883605733-b6bc7deeulg034sncifk1upknib3b0n0.apps.googleusercontent.com'
SCOPES = [
  'https://www.googleapis.com/auth/drive.metadata.readonly'
  'https://www.googleapis.com/auth/drive.file'
]

###*
* Check if current user has authorized this application.
###

window.checkAuth = ->
  gapi.auth.authorize {
    'client_id': CLIENT_ID
    'scope': SCOPES.join(' ')
    'immediate': true
  }, handleAuthResult
  return

###*
* Handle response from authorization server.
*
* @param {Object} authResult Authorization result.
###

handleAuthResult = (authResult) ->
  authorizeDiv = document.getElementById('authorize-div')
  if authResult and !authResult.error
    # Hide auth UI, then load client library.
    authorizeDiv.style.display = 'none'
    loadDriveApi()
  else
    # Show auth UI, allowing the user to initiate authorization by
    # clicking authorize button.
    authorizeDiv.style.display = 'inline'
  return

###*
* Initiate auth flow in response to user clicking authorize button.
*
* @param {Event} event Button click event.
###

window.handleAuthClick = (event) ->
  gapi.auth.authorize {
    client_id: CLIENT_ID
    scope: SCOPES
    immediate: false
  }, handleAuthResult
  false

###*
* Load Drive API client library.
###

loadDriveApi = ->
  gapi.client.load 'drive', 'v2', listFiles
  return

###*
* Print files.
###

listFiles = ->
  request = gapi.client.drive.files.list('maxResults': 10)
  request.execute (resp) ->
    appendPre 'Files:'
    files = resp.items
    if files and files.length > 0
      i = 0
      while i < files.length
        file = files[i]
        appendPre file.title + ' (' + file.id + ')'
        i++
    else
      appendPre 'No files found.'
    return
  return

###*
* Append a pre element to the body containing the given message
* as its text node.
*
* @param {string} message Text to be placed in pre element.
###

appendPre = (message) ->
  pre = document.getElementById('output')
  textContent = document.createTextNode(message + '\\n')
  pre.appendChild textContent
  return

###*
# Insert new file.
#
# @param {File} fileData File object to read data from.
# @param {Function} callback Function to call when the request is complete.
###

window.insertFile = (name, data, callback) ->
  boundary = '-------314159265358979323846'
  delimiter = '\r\n--' + boundary + '\r\n'
  close_delim = '\r\n--' + boundary + '--'


  contentType = 'application/json'
  metadata =
    'title': name
  base64Data = btoa(JSON.stringify(data))
  multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: ' + contentType + '\r\n' + 'Content-Transfer-Encoding: base64\r\n' + '\r\n' + base64Data + close_delim
  request = gapi.client.request(
    'path': '/upload/drive/v2/files'
    'method': 'POST'
    'params': 'uploadType': 'multipart'
    'headers': 'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
    'body': multipartRequestBody)
  if !callback

    callback = (file) ->
      console.log file
      return

  request.execute callback
  return

  return

# ---
# generated by js2coffee 2.1.0
